
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Source: observer/index.js | Vialer-js</title>
    <link type="text/css" rel="stylesheet" href="styles/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="styles/main.css">

    
</head>
<body>
<div class="main-container">
    <input type="checkbox" id="nav-trigger" class="nav-trigger">
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>
    <label for="nav-trigger" class="overlay"></label>
    <nav class="lnb" id="lnb">
        <div class="nav-search js-search">
            <div class="logo" style="width: 72px; height: 72px">
                <img src="logo-64.png" width="100%" height="100%">
            </div>
            <input type="text" placeholder="Search docs">
            <ul class="searched-list"></ul>
        </div>

        <div class="nav-main">
            <h1><a href="index.html" class="link">Vialer-js</a></h1>
            <span class="version">
            
                v3.0.91
            
            </span>
        </div>

        
        <ol class="nav-tab">
            <li id="api-tab">
                <a href="#api"><h4>Code</h4></a>
            </li>
            <li id="manuals-tab">
                <a href="#manuals"><h4>Manuals</h4></a>
            </li>
        </ol>
        

        <div class="scroll">
        <div class="nav-manuals hidden"><h3>Manuals</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-branding.html">Branding</a>
                <div class="nav-item-sub hidden" id="branding_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-deployment.html">Deployment</a>
                <div class="nav-item-sub hidden" id="deployment_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-development.html">Development</a>
                <div class="nav-item-sub hidden" id="development_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="tutorial-install.html">Building</a>
                <div class="nav-item-sub hidden" id="install_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Modules</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-env.html">env</a>
                <div class="nav-item-sub hidden" id="module_env_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-env.html#~getEnvironment">getEnvironment</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-helpers.html">helpers</a>
                <div class="nav-item-sub hidden" id="module_helpers_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-helpers.html#~Helpers">Helpers</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleApp.html">ModuleApp</a>
                <div class="nav-item-sub hidden" id="module_ModuleApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleAvailability.html">ModuleAvailability</a>
                <div class="nav-item-sub hidden" id="module_ModuleAvailability_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleCalls.html">ModuleCalls</a>
                <div class="nav-item-sub hidden" id="module_ModuleCalls_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleContacts.html">ModuleContacts</a>
                <div class="nav-item-sub hidden" id="module_ModuleContacts_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleExtension.html">ModuleExtension</a>
                <div class="nav-item-sub hidden" id="module_ModuleExtension_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleQueues.html">ModuleQueues</a>
                <div class="nav-item-sub hidden" id="module_ModuleQueues_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleSettings.html">ModuleSettings</a>
                <div class="nav-item-sub hidden" id="module_ModuleSettings_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleUI.html">ModuleUI</a>
                <div class="nav-item-sub hidden" id="module_ModuleUI_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleUser.html">ModuleUser</a>
                <div class="nav-item-sub hidden" id="module_ModuleUser_sub"></div>
            </li></ul></div><div class="nav-api hidden"><h3>Namespaces</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#.helpers">helpers</a></a></li><li class="sub-nav-item"><a href="App.html#.this.sounds">this.sounds</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#__initStore">__initStore</a></a></li><li class="sub-nav-item"><a href="App.html#__isObject">__isObject</a></a></li><li class="sub-nav-item"><a href="App.html#__mergeDeep">__mergeDeep</a></a></li><li class="sub-nav-item"><a href="App.html#__mergeState">__mergeState</a></a></li><li class="sub-nav-item"><a href="App.html#_initialState">_initialState</a></a></li><li class="sub-nav-item"><a href="App.html#initI18n">initI18n</a></a></li><li class="sub-nav-item"><a href="App.html#setState">setState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppBackground.html">AppBackground</a>
                <div class="nav-item-sub hidden" id="AppBackground_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppBackground.html#__factoryDefaults">__factoryDefaults</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__initServices">__initServices</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__initStore">__initStore</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__logoutState">__logoutState</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__unlockVault">__unlockVault</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#_platformData">_platformData</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#_restoreState">_restoreState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppForeground.html">AppForeground</a>
                <div class="nav-item-sub hidden" id="AppForeground_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppForeground.html#__initStore">__initStore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppObserver.html">AppObserver</a>
                <div class="nav-item-sub hidden" id="AppObserver_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppObserver.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#insertIconInDom">insertIconInDom</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#revertInsertedIcons">revertInsertedIcons</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sounds.html">Sounds</a>
                <div class="nav-item-sub hidden" id="Sounds_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="Sounds.html#.context">context</a></a></li></ul></div>
            </li></ul></div><div class="nav-api hidden"><h3>Classes</h3><ul class="nav-items"><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Api.html">Api</a>
                <div class="nav-item-sub hidden" id="Api_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Api.html#setupClient">setupClient</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.html">App</a>
                <div class="nav-item-sub hidden" id="App_sub"><div class="member-type">Members</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#.helpers">helpers</a></a></li><li class="sub-nav-item"><a href="App.html#.this.sounds">this.sounds</a></a></li></ul><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.html#__initStore">__initStore</a></a></li><li class="sub-nav-item"><a href="App.html#__isObject">__isObject</a></a></li><li class="sub-nav-item"><a href="App.html#__mergeDeep">__mergeDeep</a></a></li><li class="sub-nav-item"><a href="App.html#__mergeState">__mergeState</a></a></li><li class="sub-nav-item"><a href="App.html#_initialState">_initialState</a></a></li><li class="sub-nav-item"><a href="App.html#initI18n">initI18n</a></a></li><li class="sub-nav-item"><a href="App.html#setState">setState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="App.Utils.html">Utils</a>
                <div class="nav-item-sub hidden" id="App_Utils_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="App.Utils.html#sanitizeNumber">sanitizeNumber</a></a></li><li class="sub-nav-item"><a href="App.Utils.html#stringifySearch">stringifySearch</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppBackground.html">AppBackground</a>
                <div class="nav-item-sub hidden" id="AppBackground_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppBackground.html#__factoryDefaults">__factoryDefaults</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__initServices">__initServices</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__initStore">__initStore</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__logoutState">__logoutState</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#__unlockVault">__unlockVault</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#_platformData">_platformData</a></a></li><li class="sub-nav-item"><a href="AppBackground.html#_restoreState">_restoreState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppBackground.Tabs.html">Tabs</a>
                <div class="nav-item-sub hidden" id="AppBackground_Tabs_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppBackground.Tabs.html#contextMenuItems">contextMenuItems</a></a></li><li class="sub-nav-item"><a href="AppBackground.Tabs.html#signalIcons">signalIcons</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppForeground.html">AppForeground</a>
                <div class="nav-item-sub hidden" id="AppForeground_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppForeground.html#__initStore">__initStore</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppObserver.html">AppObserver</a>
                <div class="nav-item-sub hidden" id="AppObserver_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppObserver.html#createNumberIconElement">createNumberIconElement</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#escapeHTML">escapeHTML</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#handleMutations">handleMutations</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#insertIconInDom">insertIconInDom</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#observePage">observePage</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#processPage">processPage</a></a></li><li class="sub-nav-item"><a href="AppObserver.html#revertInsertedIcons">revertInsertedIcons</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="AppObserver.Walker.html">Walker</a>
                <div class="nav-item-sub hidden" id="AppObserver_Walker_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="AppObserver.Walker.html#getBlockedRoles">getBlockedRoles</a></a></li><li class="sub-nav-item"><a href="AppObserver.Walker.html#getBlockedTagNames">getBlockedTagNames</a></a></li><li class="sub-nav-item"><a href="AppObserver.Walker.html#isBlockedElement">isBlockedElement</a></a></li><li class="sub-nav-item"><a href="AppObserver.Walker.html#skipNode">skipNode</a></a></li><li class="sub-nav-item"><a href="AppObserver.Walker.html#walkTheDOM">walkTheDOM</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Call.html">Call</a>
                <div class="nav-item-sub hidden" id="Call_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Call.html#_incoming">_incoming</a></a></li><li class="sub-nav-item"><a href="Call.html#_outgoing">_outgoing</a></a></li><li class="sub-nav-item"><a href="Call.html#_start">_start</a></a></li><li class="sub-nav-item"><a href="Call.html#_stop">_stop</a></a></li><li class="sub-nav-item"><a href="Call.html#setState">setState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallConnectAB.html">CallConnectAB</a>
                <div class="nav-item-sub hidden" id="CallConnectAB_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="CallConnectAB.html#_callStatus">_callStatus</a></a></li><li class="sub-nav-item"><a href="CallConnectAB.html#hold">hold</a></a></li><li class="sub-nav-item"><a href="CallConnectAB.html#unhold">unhold</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="CallSIP.html">CallSIP</a>
                <div class="nav-item-sub hidden" id="CallSIP_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="CallSIP.html#_incoming">_incoming</a></a></li><li class="sub-nav-item"><a href="CallSIP.html#_outgoing">_outgoing</a></a></li><li class="sub-nav-item"><a href="CallSIP.html#accept">accept</a></a></li><li class="sub-nav-item"><a href="CallSIP.html#terminate">terminate</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Contact.html">Contact</a>
                <div class="nav-item-sub hidden" id="Contact_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Contact.html#setState">setState</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Crypto.html">Crypto</a>
                <div class="nav-item-sub hidden" id="Crypto_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Crypto.html#__base64ToDataArray">__base64ToDataArray</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__dataArray">__dataArray</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__dataArrayToBase64">__dataArrayToBase64</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__dataArrayToHex">__dataArrayToHex</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__dataArrayToString">__dataArrayToString</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__deriveAESKeyFromECDH">__deriveAESKeyFromECDH</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__exportAESKey">__exportAESKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__exportPrivateKey">__exportPrivateKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__exportPublicKey">__exportPublicKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__hashString">__hashString</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__importPrivateKey">__importPrivateKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__importPublicKey">__importPublicKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#__stringToDataArray">__stringToDataArray</a></a></li><li class="sub-nav-item"><a href="Crypto.html#_generateVaultKey">_generateVaultKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#_importVaultKey">_importVaultKey</a></a></li><li class="sub-nav-item"><a href="Crypto.html#decrypt">decrypt</a></a></li><li class="sub-nav-item"><a href="Crypto.html#encrypt">encrypt</a></a></li><li class="sub-nav-item"><a href="Crypto.html#loadIdentity">loadIdentity</a></a></li><li class="sub-nav-item"><a href="Crypto.html#storeVault">storeVault</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="MemoryStore.html">MemoryStore</a>
                <div class="nav-item-sub hidden" id="MemoryStore_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Module.html">Module</a>
                <div class="nav-item-sub hidden" id="Module_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleApp-ModuleApp.html">ModuleApp</a>
                <div class="nav-item-sub hidden" id="module_ModuleApp_ModuleApp_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleAvailability-ModuleAvailability.html">ModuleAvailability</a>
                <div class="nav-item-sub hidden" id="module_ModuleAvailability_ModuleAvailability_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleAvailability-ModuleAvailability.html#_platformData">_platformData</a></a></li><li class="sub-nav-item"><a href="module-ModuleAvailability-ModuleAvailability.html#_watchers">_watchers</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleCalls-ModuleCalls.html">ModuleCalls</a>
                <div class="nav-item-sub hidden" id="module_ModuleCalls_ModuleCalls_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#__setTransferState">__setTransferState</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#__uaOptions">__uaOptions</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#_emptyCall">_emptyCall</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#_formatSdp">_formatSdp</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#_userAgent">_userAgent</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#activateCall">activateCall</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#activeCall">activeCall</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#callAction">callAction</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#connect">connect</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#deleteCall">deleteCall</a></a></li><li class="sub-nav-item"><a href="module-ModuleCalls-ModuleCalls.html#disconnect">disconnect</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleContacts-ModuleContacts.html">ModuleContacts</a>
                <div class="nav-item-sub hidden" id="module_ModuleContacts_ModuleContacts_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleContacts-ModuleContacts.html#_platformData">_platformData</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleExtension-ModuleExtension.html">ModuleExtension</a>
                <div class="nav-item-sub hidden" id="module_ModuleExtension_ModuleExtension_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleExtension-ModuleExtension.html#_installUpdate">_installUpdate</a></a></li><li class="sub-nav-item"><a href="module-ModuleExtension-ModuleExtension.html#_keyboardShortcuts">_keyboardShortcuts</a></a></li><li class="sub-nav-item"><a href="module-ModuleExtension-ModuleExtension.html#_ready">_ready</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleQueues-ModuleQueues.html">ModuleQueues</a>
                <div class="nav-item-sub hidden" id="module_ModuleQueues_ModuleQueues_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleQueues-ModuleQueues.html#setQueueSizesTimer">setQueueSizesTimer</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleUI-ModuleUI.html">ModuleUI</a>
                <div class="nav-item-sub hidden" id="module_ModuleUI_ModuleUI_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleUI-ModuleUI.html#__menubarAnimation">__menubarAnimation</a></a></li><li class="sub-nav-item"><a href="module-ModuleUI-ModuleUI.html#_initialState">_initialState</a></a></li><li class="sub-nav-item"><a href="module-ModuleUI-ModuleUI.html#_restoreState">_restoreState</a></a></li><li class="sub-nav-item"><a href="module-ModuleUI-ModuleUI.html#_watchers">_watchers</a></a></li><li class="sub-nav-item"><a href="module-ModuleUI-ModuleUI.html#notification">notification</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="module-ModuleUser-ModuleUser.html">ModuleUser</a>
                <div class="nav-item-sub hidden" id="module_ModuleUser_ModuleUser_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="module-ModuleUser-ModuleUser.html#_initialState">_initialState</a></a></li><li class="sub-nav-item"><a href="module-ModuleUser-ModuleUser.html#_platformData">_platformData</a></a></li><li class="sub-nav-item"><a href="module-ModuleUser-ModuleUser.html#login">login</a></a></li><li class="sub-nav-item"><a href="module-ModuleUser-ModuleUser.html#logout">logout</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Presence.html">Presence</a>
                <div class="nav-item-sub hidden" id="Presence_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="PresenceSip.html">PresenceSip</a>
                <div class="nav-item-sub hidden" id="PresenceSip_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="PresenceSip.html#_statusFromDialog">_statusFromDialog</a></a></li><li class="sub-nav-item"><a href="PresenceSip.html#subscribe">subscribe</a></a></li><li class="sub-nav-item"><a href="PresenceSip.html#unsubscribe">unsubscribe</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="RingTone.html">RingTone</a>
                <div class="nav-item-sub hidden" id="RingTone_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.html">Skeleton</a>
                <div class="nav-item-sub hidden" id="Skeleton_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.html#emit">emit</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#ipcListener">ipcListener</a></a></li><li class="sub-nav-item"><a href="Skeleton.html#on">on</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.Logger.html">Logger</a>
                <div class="nav-item-sub hidden" id="Skeleton_Logger_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Skeleton.Store.html">Store</a>
                <div class="nav-item-sub hidden" id="Skeleton_Store_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Skeleton.Store.html#clear">clear</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sounds.BusyTone.html">BusyTone</a>
                <div class="nav-item-sub hidden" id="Sounds_BusyTone_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sounds.DtmfTone.html">DtmfTone</a>
                <div class="nav-item-sub hidden" id="Sounds_DtmfTone_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sounds.RingbackTone.html">RingbackTone</a>
                <div class="nav-item-sub hidden" id="Sounds_RingbackTone_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Sounds.SoundMeter.html">SoundMeter</a>
                <div class="nav-item-sub hidden" id="Sounds_SoundMeter_sub"></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Telemetry.html">Telemetry</a>
                <div class="nav-item-sub hidden" id="Telemetry_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Telemetry.html#event">event</a></a></li><li class="sub-nav-item"><a href="Telemetry.html#getClientId">getClientId</a></a></li></ul></div>
            </li><li class="nav-item">
                <span class="toggle-subnav invisible btn btn-link fa fa-plus"></span>
                <a href="Timer.html">Timer</a>
                <div class="nav-item-sub hidden" id="Timer_sub"><div class="member-type">Methods</div><ul class="inner"><li class="sub-nav-item"><a href="Timer.html#__jitter">__jitter</a></a></li><li class="sub-nav-item"><a href="Timer.html#increaseTimeout">increaseTimeout</a></a></li><li class="sub-nav-item"><a href="Timer.html#setTimeout">setTimeout</a></a></li></ul></div>
            </li></ul></div>
        </div>
    </nav>

    <div class="content">
        <ul class="breadcrumbs">
            <li><a href="index.html">Docs</a> »</li>
            <li>Source: observer/index.js</li>
        </ul>
        <hr>
        



    
<article>
    <pre class="prettyprint source linenums"><code>/**
* @namespace AppObserver
*/
// Provide some third-party dependencies from vendor.js
global.EventEmitter = require('eventemitter3')
global.$ = document.querySelector.bind(document)
global.$$ = document.querySelectorAll.bind(document)

const Skeleton = require('../lib/skeleton')
const Walker = require('./walker')
const utils = require('../lib/utils')


/**
* The ObserverFrame is injected in ALL browser tab frames, because it has to
* be able to add click-to-dial icons to every phonenumber it finds.
* This script needs to be as lightweight as possible, so it doesn't
* affect browsing performance too much.
*/
class AppObserver extends Skeleton {
    /**
    * @param {Object} opts - Options to initialize AppBackground with.
    * @param {Object} opts.env - The environment sniffer.
    */
    constructor(opts) {
        super(opts)

        this.parsers = require('./parsers')
        this.walker = new Walker(this)
        // Search and insert icons after mutations.
        this.observer = null
        this.handleMutationsTimeout = null
        this.parkedNodes = []
        this.stylesheet = document.createElement('link')
        this.stylesheet.setAttribute('rel', 'stylesheet')
        this.stylesheet.setAttribute('href', browser.runtime.getURL('css/observer.css'))
        $('head').appendChild(this.stylesheet)
        /**
        * Toggle listening to DOM mutations and adding icons to the tab.
        * Triggered when the user logs out or when the click2dial
        * setting is modified from the popup.
        */
        this.on('observer:click2dial:toggle', ({enabled, label, numbers}) => {
            if (numbers.length) {
                // Target a specific number/icon.
                for (let number of numbers) {
                    // Target icons.
                    for (let node of $$(`.ctd-icon-${number}`)) {
                        if (enabled) node.classList.remove('ctd-disabled')
                        else node.classList.add('ctd-disabled')

                        if (label) {
                            node.classList.add('ctd-label')
                            node.setAttribute('data-content', label)
                        } else {
                            node.classList.remove('ctd-label')
                            node.removeAttribute('data-content')
                        }
                    }
                    // Target links with `tel:` hrefs. These don't have
                    // labels.
                    for (let node of $$(`a[href^="tel:${number}"]`)) {
                        if (enabled) node.classList.remove('ctd-disabled')
                        else node.classList.add('ctd-disabled')
                    }
                }
            } else {
                // For the whole page.
                if (enabled) {
                    this.processPage()
                } else {
                    if (this.observer) this.observer.disconnect()
                    // Remove icons.
                    this.revertInsertedIcons()
                    this.stylesheet.remove()
                }
            }
        })

        /**
        * Signal the background that the observer has been loaded and is
        * ready to look for phone numbers if the background demands it.
        */
        this.emit('bg:tabs:observer_toggle', {
            callback: ({observe}) => {
                // Don't start observing, unless the background says so.
                if (!observe) return

                if (window !== window.top &amp;&amp; !(document.body.offsetWidth > 0 || document.body.offsetHeight > 0)) {
                    // This is a hidden iframe. We wait for it to become visible,
                    // before starting the observer.
                    const resizeListener = (e) => {
                        this.processPage()
                        window.removeEventListener('resize', resizeListener)
                    }
                    this.resizeListener = window.addEventListener('resize', resizeListener)
                } else {
                    this.processPage()
                }
            },
        })


        /**
        * Event delegate for the whole page. Respond to &lt;A> tags
        * and &lt;CTDICON> tags; otherwise just let it pass.
        */
        document.addEventListener('click', (e) => {
            if (e.target.nodeName === 'A') {
                // Handle links with hrefs starting with `tel:`.
                const href = e.target.getAttribute('href')
                if (href.startsWith('tel:')) {
                    e.preventDefault()
                    if (e.target.classList.contains('ctd-disabled')) return
                    const number = href.substring(4)
                    this.emit('bg:calls:call_create', {number, start: true})
                    // Immediatly disable all the links with this number and
                    // let the `observer:click2dial:toggle` event further decide
                    // whether the user should be able to interact with a tel link.
                    for (let node of $$(`a[href^="tel:${number}"]`)) {
                        node.classList.add('ctd-disabled')
                    }
                }
            } else if (e.target.nodeName === 'CTDICON') {
                // Handle clicking on injected c2d icons.
                e.preventDefault()
                if (e.target.classList.contains('ctd-disabled')) return
                const data = e.target.dataset
                if (data.number) this.emit('bg:calls:call_create', {number: data.number, start: true})
                // Immediatly disable all the c2d icons for this number and
                // let the `observer:click2dial:toggle` event further decide
                // whether the user should be able to interact with an icon.
                for (let node of $$(`.ctd-icon-${data.number}`)) {
                    node.classList.add('ctd-disabled')
                }
            }
        })
    }


    /**
    * Create an HTML element containing an anchor with a phone icon with
    * the phone number in a data attribute.
    * @param {String} number - Number to use for the icon.
    * @returns {Node} - Newly created p element.
    */
    createNumberIconElement(number) {
        number = utils.sanitizeNumber(number)
        let icon = document.createElement('ctdicon')
        icon.classList.add('ctd-icon', `ctd-icon-${number}`)
        icon.setAttribute('data-number', number)
        return icon
    }


    /**
    * Escape HTML chars when assigning text to innerHTML.
    * @param {String} str - The string to escape html from.
    * @returns {String} - The HTML escaped string.
    */
    escapeHTML(str) {
        const replacements = {
            '"': '&amp;quot;',
            '&amp;': '&amp;amp;',
            '&lt;': '&amp;lt;',
            '>': '&amp;gt;',
        }
        return str.replace(/[&amp;"&lt;>]/g, (m) => replacements[m])
    }


    /**
     * Process parked DOM mutations.
     */
    handleMutations() {
        // Copy and clear parkedNodes.
        let _parkedNodes = this.parkedNodes.slice()
        this.parkedNodes = []
        // Handle mutations if it probably isn't too much to handle
        // (current limit is totally random).
        if (_parkedNodes.length &lt; 151) {
            this.logger.debug(`${this}processing ${_parkedNodes.length} parked nodes.`)
            let batchSize = 40 // random size
            for (let i = 0; i &lt; Math.ceil(_parkedNodes.length / batchSize); i++) {
                ((index) => {
                    setTimeout(() => {
                        for (let j = index * batchSize; j &lt; (index + 1) * batchSize; j++) {
                            let node = _parkedNodes[j]
                            let stillInDocument = document.contains(node) // no lookup costs
                            if (stillInDocument) {
                                this.insertIconInDom(node)
                            }
                        }
                    }, 0) // Push back execution to the end on the current event stack.
                })(i)
            }
        }
    }


    /**
    * Transforms matching phonenumbers in augmented
    * elements which contain the icon.
    * @param {Node} [root] - The DOM node to start matching from.
    */
    insertIconInDom(root) {
        const pause = !!root
        if (pause &amp;&amp; this.observer) this.observer.disconnect()
        root = root || document.body

        // Walk the DOM looking for elements to parse, but block reasonably
        // sized pages to prevent locking the page.
        const childrenLength = root.querySelectorAll('*').length // no lookup costs
        if (childrenLength >= 2001) return

        this.walker.walkTheDOM(root, (currentNode) => {
            // Scan using every available parser.
            this.parsers.forEach((localeParser) => {
                const parser = localeParser[1]()
                // Transform Text node to HTML-capable node, to
                // - deal with html-entities (&amp;nbsp;, &amp;lt;, etc.) since
                // they mess up the start/end from matches when reading
                // from node.data, and
                // - enable inserting the icon html
                // (doesn't work with a text node)
                const ctdNode = document.createElement('ctd')
                ctdNode.classList.add('ctd-phone-number')
                // ctdNode.textContent = currentNode.data
                const nodeData = this.escapeHTML(currentNode.data)
                const matches = parser.parse(nodeData)
                if (matches.length) {
                    if (!parser.isBlockingNode(currentNode.previousElementSibling) &amp;&amp;
                            !parser.isBlockingNode(currentNode.parentNode.previousElementSibling)) {

                        matches.reverse().forEach((match) => {
                            const numberIconElement = this.createNumberIconElement(match.number)
                            ctdNode.setAttribute('data-original', nodeData)
                            const numberText = nodeData.slice(match.start, match.end)
                            const beforeText = nodeData.slice(0, match.start)
                            const afterText = nodeData.slice(match.end)

                            const numberTextNode = document.createTextNode(numberText)
                            // There may be text in front of the phonenumber.
                            if (beforeText.length) {
                                const beforeTextNode = document.createTextNode(beforeText)
                                ctdNode.appendChild(beforeTextNode)
                            }
                            // The phonenumber itself.
                            ctdNode.appendChild(numberTextNode)
                            // The icon.
                            ctdNode.appendChild(numberIconElement)
                            // And finally text after the icon when there is any.
                            if (afterText.length) {
                                const afterTextNode = document.createTextNode(afterText)
                                ctdNode.appendChild(afterTextNode)
                            }
                        })

                        currentNode.parentNode.insertBefore(ctdNode, currentNode)
                        currentNode.parentNode.removeChild(currentNode)
                    }
                }
            })
        })

        if (pause) this.observePage()
    }


    /**
     * Observer start: listen for DOM mutations and let `handleMutations`
     * process them.
     */
    observePage() {
        if (!this.observer) {
            this.observer = new MutationObserver((mutations) => {
                if (this.handleMutationsTimeout) {
                    // Don't handle the mutations yet after all.
                    clearTimeout(this.handleMutationsTimeout)
                }

                mutations.forEach((mutation) => {
                    // Filter mutations to park.
                    if (mutation.addedNodes.length) {
                        for (const node of mutation.addedNodes) {
                            if (!this.walker.skipNode(node)) {
                                this.parkedNodes.push(node)
                            }
                        }
                    } else if (!mutation.removedNodes.length &amp;&amp; mutation.target) {
                        if (!this.walker.skipNode(mutation.target)) {
                            this.parkedNodes.push(mutation.target)
                        }
                    }
                })

                // Assuming nothing happens, scan the nodes in 500 ms - after
                // this the page should've been done dealing with the mutations.
                if (this.parkedNodes.length) {
                    this.handleMutationsTimeout = setTimeout(this.handleMutations.bind(this), 500)
                }
            })
        }

        if (this.observer) {
            this.observer.observe(document.body, {childList: true, subtree: true})
        }
    }


    /**
    * Injects icons in the page and start observing the page for changes.
    */
    processPage() {
        this.logger.debug(`${this}start observing`)
        $('head').appendChild(this.stylesheet)
        this.insertIconInDom()
        this.observePage()
    }


    /**
     * Restore the original numbers by replacing all ctd nodes with a new
     * text node containing the phonenumber.
     */
    revertInsertedIcons() {
        $$('ctd').forEach((el) => {
            el.parentNode.replaceChild(document.createTextNode(el.dataset.original), el)
        })
    }
}


let env = require('../lib/env')({role: 'observer'})
global.app = new AppObserver({env})
</code></pre>
</article>





        <hr>
        <footer>
            <strong>&copy; Devhouse Spindle</strong><br/>
            Documented with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
        </footer>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>

window.isApi = true
window.isManual = false
window.doc = {
    name: '',
    longname: '',
}

if (!doc.name) isApi = false

</script>
<script src="js/rtd.js"></script>
</body>
</html>
